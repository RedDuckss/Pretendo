(function(){Wood.Model.RedeemableCard=Wood.Model.Base.extend({url:function(){return Wood.UrlPrefix.NINJA+"ws/redeemable_card/!check"},fetch:function(a){var d=this.getBaseAjaxParam();$.extend(d,{type:"POST",async:!1,data:{card_number:this.card_number},xhrFields:{withCredentials:!0}});$.extend(d,a);this.fetchJSON(d)},parse:function(a){return a.redeemable_card},toJSON:function(){return JSON.stringify(this.attributes)},getNumber:function(){return this.get("number")},getPreOrder:function(){return this.get("pre_order")},
getContents:function(){return this.getSafe("contents.content")},getFirstContent:function(){var a=this.getContents();return!a||0===a.length?null:a[0]},isAOC:function(){var a=this.getFirstContent();return!(!a||!a.aoc)},isTicket:function(){var a=this.getFirstContent();return!(!a||!a.ticket)},isTitle:function(){var a=this.getFirstContent();return!(!a||!a.title)},getReferenceTitleId:function(){return this.get("reference_title_id")},getCash:function(){return this.get("cash")},isCash:function(){return!!this.getCash()},
isTitleCTR:function(){return!this.isTitle()?!1:!!this.getFirstContent().title.id.toString().match(/^5/)},isTitleWUP:function(){return!this.isTitle()?!1:!!this.getFirstContent().title.id.toString().match(/^2/)}});Wood.Model.RedeemableCard.isValidNumber=function(a){return a&&"string"===typeof a&&/^[a-zA-Z0-9]{16}$/.test(a)?!0:!1};Wood.Model.RedeemableCard.hasUnusedChar=function(a){return a&&"string"===typeof a&&/[IOZ\-]/i.test(a)?!0:!1}})();(function(){Wood.Model.IdPair=Wood.Model.Base.extend({url:function(){return Wood.UrlPrefix.NINJA+"ws/titles/id_pair"},fetch:function(a){var d=this.getBaseAjaxParam();$.extend(d,{type:"GET",async:!1,data:{"ns_uid[]":this.ns_uid},xhrFields:{withCredentials:!0}});$.extend(d,a);this.fetchJSON(d)},parse:function(a){return a.title_id_pairs.title_id_pair[0]},getNsUid:function(){return this.get("ns_uid")},getTitleId:function(){return this.get("title_id")},getType:function(){return this.get("type")}})})();(function(){Wood.Controller.Top03_01=Wood.Controller.Base.extend({preparePage:function(a,d){this.setupMenu(Wood.View.MenuBar.Type.DEFAULT);var c=this.parseParam();this.menuBar.hookBackEvent(function(){c.backurl?wood.client.redirectTo(c.backurl):d.isAppJump()?wood.client.redirectTo("data01_03.html",{cancel:"historyback"}):wood.client.historyBack()});Wood.Analytics.addFromAttr("dl_no").sendVirtualPV("VP_RedeemInput")},run:function(a,d){var c=this;c.clearRedeemForm();var f=null,b=$('input[name="redeem_num"]'),
f=this.parseParam();if(d.isAppJump()||d.isFromPurchaseComplete())b.val(f.card_number),$("#sel_redeem_next").show();var e=function(a){a&&a.preventDefault();wood.client.disableUserOperation(!0);if(""===b.val()||b.val()===$("#str_input").text())return wood.client.enableUserOperation(!0),!1;a=b.val();Wood.Model.RedeemableCard.hasUnusedChar(a)?(wood.client.enableUserOperation(!0),wood.client.alert($("#dialog_msg_unused_char").text(),$("#dialog_ok").text())):Wood.Model.RedeemableCard.isValidNumber(a)?c.verifyRedeemableNumber(a,
!1):(wood.client.enableUserOperation(!0),wood.client.alert($("#dialog_msg_invalid").text(),$("#dialog_ok").text()))};b.on("change",function(){if(d.isAppJump())return!1;e.call()});$("#evt_redeem").on("click",e);var g=wood.client.getSessionStorage();"checkNum"===f.seq&&Wood.Util.isDefined(g.getItem("redeem_num"))?(f=g.getItem("redeem_num"),this.verifyRedeemableNumber(f,!0)):this.showPage()},verifyRedeemableNumber:function(a,d){var c=new Wood.Model.RedeemableCard({card_number:a});c.fetch();if(c.isTitle()&&
!c.isTitleWUP())if(wood.client.enableUserOperation(!0),wood.client.alert($("#dialog_msg_invalid").text(),$("#dialog_ok").text()),d)wood.client.historyBack();else return;var f=wood.client.getSessionStorage(),b=f.getItem("prepaid_card_available");if(c.isCash()&&"true"!==b)wood.client.enableUserOperation(!0),wood.client.alert($("#dialog_msg_block_prepaid").text(),$("#dialog_ok").text());else{c.isCash()&&(wood.client.alert($("#dialog_msg").text(),$("#dialog_ok").text()),f.setItem("card_num",c.getNumber()),
wood.client.redirectTo("money02_01.html?seq=checkNum"));wood.client.clearRedeemableCard();var e=b=null,b=null;if(c.isTitle())e=c.getFirstContent().title.id,b=new Wood.Model.IdPair({ns_uid:e}),b.fetch(),b=b.getTitleId(),e="buy01_01.html?type=title&seq=redeem&title="+e,c.getPreOrder()&&(e+="&pre_order=true");else if(c.isAOC())b=new Wood.Model.IdPair({ns_uid:c.getReferenceTitleId()}),b.fetch(),b=b.getTitleId(),e=Wood.URL.create("data03_01_redeem.html",{redeem_title_id:b});else if(c.isTicket())b=new Wood.Model.IdPair({ns_uid:c.getReferenceTitleId()}),
b.fetch(),b=b.getTitleId(),e=Wood.URL.create("data04_01_redeem.html",{redeem_title_id:b});else{Wood.log("strange redeemable_card_num: "+a);return}f.setItem("redeem_title_id",b);f.setItem("redeem_num",c.getNumber());wood.client.setRedeemableCard(c);d?wood.client.redirectReplaceTo(e):wood.client.redirectTo(e)}},clearRedeemForm:function(){$('input[name="redeem_num"]').attr("placeholder",$("#str_redeem_num").text()).val("").blur()},onPageShowCache:function(){this.clearRedeemForm();wood.client.clearRedeemableCard()}})})();
